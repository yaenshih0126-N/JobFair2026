<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DHL é–ƒé›»åˆ†æ€å“¡ - å°ˆæ¥­æ‰“æ«ƒç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #FFCC00; /* DHL é»ƒ */
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            touch-action: none;
            height: 100dvh; 
            width: 100vw;
            margin: 0;
        }
        .dhl-red { color: #D40000; }
        .bg-dhl-red { background-color: #D40000; }
        
        #game-container {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding-top: 5px;
        }

        #music-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #D40000;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #work-area {
            flex-grow: 1;
            width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            overflow: hidden;
        }

        .package {
            width: 220px; 
            min-height: 160px; 
            background: #FFCC00; 
            border: 3px solid #333; 
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); 
            z-index: 100;
            padding: 10px;
            text-align: center;
            pointer-events: auto;
        }

        .package::after {
            content: '';
            position: absolute;
            bottom: 12px;
            left: 0;
            width: 100%;
            height: 6px;
            background: #D40000; 
            border-top: 1.5px solid #333;
            border-bottom: 1.5px solid #333;
        }

        .label-area {
            background: white;
            border: 2px solid #333;
            border-radius: 6px;
            padding: 10px;
            width: 95%;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            z-index: 10;
        }

        footer {
            height: 180px; /* å¢åŠ åº•éƒ¨é«˜åº¦ä»¥å®¹ç´å¤šè¡Œæ–‡å­— */
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 12px 12px 12px;
            z-index: 30;
            background: linear-gradient(to top, rgba(0,0,0,0.05), transparent);
        }

        .pallet-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 47%;
        }

        .pallet-container {
            width: 100%;
            height: 100px;
            background: rgba(255, 255, 255, 0.4);
            border: 3px solid #D40000;
            border-top: none;
            border-radius: 0 0 10px 10px;
            display: flex;
            flex-direction: column-reverse; 
            align-items: center;
            padding-bottom: 3px;
            overflow: hidden;
        }

        .stacked-box {
            width: 92%;
            height: 18px;
            background: #FFCC00; 
            border: 1px solid #333;
            margin-bottom: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: #D40000;
            border-radius: 2px;
            animation: dropIn 0.3s ease-out;
            flex-shrink: 0;
        }

        .pallet-label {
            width: 100%;
            min-height: 48px; /* è¨­å®šæœ€å°é«˜åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 900;
            color: #D40000;
            font-size: 0.75rem; /* ç¨å¾®ç¸®å°å­—é«”ä»¥åˆ©æ›è¡Œ */
            line-height: 1.2;
            background: white;
            padding: 4px 6px;
            border: 2px solid #D40000;
            border-radius: 8px;
            margin-bottom: 4px;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            word-break: break-all; /* ç¢ºä¿é•·å–®å­—ä¹Ÿèƒ½æ›è¡Œ */
        }

        #timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 5px;
            background: #D40000;
            width: 100%;
            z-index: 200;
            transition: width 0.1s linear;
        }

        #explanation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            padding: 20px;
        }

        .hidden { display: none !important; }

        @keyframes dropIn {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
    </style>
</head>
<body>

    <div id="timer-bar"></div>
    <div id="music-toggle">ğŸ”‡</div>

    <div id="game-container">
        <!-- é–‹å§‹ç•«é¢ -->
        <div id="start-screen" class="w-full h-full flex flex-col items-center justify-center p-6 z-[200] absolute bg-[#FFCC00]">
            <h1 class="text-4xl font-black dhl-red mb-1 italic">DHL EXPRESS</h1>
            <h2 class="text-xl font-bold mb-8 text-gray-800">å°ˆæ¥­æ‰“æ«ƒæŒ‘æˆ°è³½</h2>
            <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-xs w-full text-center border-4 border-black">
                <div class="w-16 h-12 bg-[#FFCC00] mx-auto mb-6 border-2 border-black relative flex items-center justify-center rounded">
                    <span class="font-black text-red-600 italic text-md">DHL</span>
                </div>
                <p class="text-base text-gray-700 mb-8 font-bold leading-relaxed">æŒ‘æˆ°ä¸å¯èƒ½ä»»å‹™ï¼<br>å·¦å³æ»‘å‹•ç´™ç®±å®Œæˆåˆ†æ€ã€‚</p>
                <button id="start-btn" class="w-full bg-dhl-red text-white py-4 rounded-2xl text-xl font-bold shadow-[0_5px_0_#990000] active:translate-y-1 active:shadow-none">
                    å•Ÿå‹•ä»»å‹™
                </button>
            </div>
        </div>

        <!-- éŠæˆ²ä¸»ç•«é¢ -->
        <div id="game-play" class="hidden flex flex-col h-full w-full">
            <header>
                <div class="text-gray-600 font-bold text-[10px] uppercase tracking-widest">Efficiency Score</div>
                <div id="score" class="text-3xl font-black dhl-red">0</div>
            </header>

            <div id="work-area"></div>

            <footer>
                <div class="pallet-wrap">
                    <div id="left-label" class="pallet-label">A</div>
                    <div id="left-pallet" class="pallet-container"></div>
                </div>
                <div class="pallet-wrap">
                    <div id="right-label" class="pallet-label">B</div>
                    <div id="right-pallet" class="pallet-container"></div>
                </div>
            </footer>
        </div>

        <!-- ç­”æ¡ˆè§£æç•«é¢ -->
        <div id="explanation-overlay" class="hidden">
            <div class="bg-white w-full max-w-sm rounded-3xl border-4 border-black p-6 shadow-2xl">
                <div id="result-indicator" class="text-2xl font-black mb-3 italic">CORRECT!</div>
                <div class="h-1 bg-gray-100 mb-4"></div>
                <p id="explanation-text" class="text-gray-700 text-sm font-medium leading-relaxed mb-6"></p>
                <button id="next-task-btn" class="w-full bg-dhl-red text-white py-4 rounded-xl font-black text-lg shadow-[0_4px_0_#990000] active:translate-y-1 active:shadow-none">
                    ä¸‹ä¸€å€‹ä»»å‹™
                </button>
            </div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="result-screen" class="hidden w-full h-full flex flex-col items-center justify-center p-6 z-[300] absolute bg-[#FFCC00]">
            <h2 class="text-3xl font-black dhl-red mb-4 italic text-center">ä»»å‹™å®Œæˆï¼</h2>
            <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-xs w-full text-center border-4 border-black">
                <p class="text-xs text-gray-600 font-bold uppercase tracking-wider">è£è¼‰æ•ˆç‡ç¸½è©•åˆ†</p>
                <div id="final-score" class="text-6xl font-black mb-2 dhl-red">0</div>
                <p id="rank-text" class="text-lg font-bold text-yellow-600 mb-6"></p>
                
                <button onclick="window.location.reload()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold mb-3 shadow-[0_4px_0_#333] active:translate-y-1 active:shadow-none">é‡æ–°æŒ‘æˆ°</button>
                <button id="join-team-btn" class="w-full bg-dhl-red text-white py-3 rounded-xl font-bold shadow-[0_4px_0_#990000] active:translate-y-1 active:shadow-none">åŠ å…¥å“è¶Šåœ˜éšŠ</button>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            { q: "DHLæ˜¯åœ¨å“ªè£¡æˆç«‹çš„ï¼Ÿ", left: "A. èˆŠé‡‘å±± (San Francisco)", right: "B. è¾›è¾›é‚£æ (Cincinnati)", correct: "left", desc: "DHLæ–¼1969å¹´åœ¨èˆŠé‡‘å±±æˆç«‹ï¼Œè¾›è¾›é‚£æå‰‡æ˜¯DHLåœ¨ç¾æ´²çš„ä¸»è¦è½‰é‹ä¸­å¿ƒã€‚" },
            { q: "DHL ä¸»è¦çš„æ¥­å‹™æ˜¯ä»€éº¼ï¼Ÿ", left: "A. å°ˆæ¥­åœ‹éš›ç‰©æµæœå‹™", right: "B. é»é¤å¹³å°å¤–é€æœå‹™", correct: "left", desc: "DHLæ˜¯ç‰©æµæ¥­çš„é ˜å°å“ç‰Œï¼Œè‡´åŠ›æ–¼æä¾›é«˜å“è³ªç‰©æµæœå‹™ï¼Œä¸¦é‹ç”¨æœ€æ–°ç§‘æŠ€ã€å¼•é ˜æ°¸çºŒç‰©æµç™¼å±•ã€‚" },
            { q: "DHL å“ç‰Œåç¨±çš„ç”±ä¾†ï¼Ÿ", left: "A. Deliver Happiness and Love", right: "B. å‰µè¾¦äººçš„å§“æ°é¦–å­—ç¸®å¯«", correct: "right", desc: "DHLç‚ºä¸‰ä½å‰µè¾¦äººAdrian Dalsey, Larry Hillblomå’ŒRobert Lynnçš„å§“æ°é¦–å­—çµ„æˆã€‚" },
            { q: "DHL çš„é›†åœ˜ç›®æ¨™ç‚ºï¼Ÿ", left: "A. 2030å¹´é›†åœ˜ç¦ç”¨å¡‘è† åŒ…æ", right: "B. 2050å¹´é”æˆæ·¨é›¶ç¢³æ’", correct: "right", desc: "DHLé›†åœ˜ç›®æ¨™ç‚ºåœ¨2050å¹´é”åˆ°æ·¨é›¶ç¢³æ’ï¼Œç›®å‰ä¹Ÿå·²æ¨å‡ºæ°¸çºŒç‰©æµçš„æœå‹™ã€‚" },
            { q: "DHLçš„logoé¡è‰²ç‚ºï¼Ÿ", left: "A. è—è‰²èƒŒæ™¯é…ç¶ è‰²å­—é«”", right: "B. é»ƒè‰²èƒŒæ™¯é…ç´…è‰²å­—é«”", correct: "right", desc: "DHL æˆç«‹åˆæœŸï¼Œlogoç‚ºç´…ç™½è‰²ï¼Œéš¨è‘—æ™‚ä»£æ¼”é€²ï¼Œè½‰è®Šç‚ºå¼·èª¿é‡‘é»ƒé€Ÿåº¦çš„ç´…é»ƒå“ç‰Œè‰²ã€‚" }
        ];

        let score = 0, timeLeft = 30, gameActive = false, timerPaused = false, questionIndex = 0;
        let currentPackage = null, startX = 0;

        // --- iPhone å¼·åŒ–éŸ³è¨Šå¼•æ“ ---
        let audioCtx = null;
        let isMusicPlaying = false;
        let nextNoteTime = 0, beat = 0;
        const tempo = 175;

        // è§£é– iOS AudioContext çš„çµ‚æ¥µæ–¹æ¡ˆ
        async function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
            // æ’­æ”¾ä¸€å€‹éœéŸ³ç·©è¡
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }

        const musicBtn = document.getElementById('music-toggle');
        
        // ä½¿ç”¨ touchstart ç¢ºä¿ iOS è­˜åˆ¥ä½¿ç”¨è€…æ„åœ–
        const handleInteraction = async () => {
            await unlockAudio();
            if (!isMusicPlaying && gameActive) {
                toggleMusic(true);
            }
        };

        musicBtn.addEventListener('click', () => toggleMusic());
        musicBtn.addEventListener('touchstart', unlockAudio, { passive: true });

        function toggleMusic(force = null) {
            isMusicPlaying = force !== null ? force : !isMusicPlaying;
            musicBtn.innerText = isMusicPlaying ? "ğŸ”Š" : "ğŸ”‡";
            if (isMusicPlaying) {
                nextNoteTime = audioCtx.currentTime;
                scheduler();
            }
        }

        function playKick(time) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.12);
            g.gain.setValueAtTime(0.4, time);
            g.gain.exponentialRampToValueAtTime(0.01, time + 0.12);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + 0.12);
        }

        function playSynth(time, freq, dur) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, time);
            g.gain.setValueAtTime(0.06, time);
            g.gain.exponentialRampToValueAtTime(0.001, time + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(time); osc.stop(time + dur);
        }

        function scheduler() {
            while (isMusicPlaying && nextNoteTime < audioCtx.currentTime + 0.1) {
                const step = beat % 4;
                if (step === 0) playKick(nextNoteTime);
                const freq = [130, 155, 174, 196][step];
                playSynth(nextNoteTime, freq, 0.1);
                nextNoteTime += 60.0 / tempo;
                beat++;
            }
            if (isMusicPlaying) setTimeout(scheduler, 25);
        }

        // --- éŠæˆ²é‚è¼¯ ---
        const startBtn = document.getElementById('start-btn');
        const nextTaskBtn = document.getElementById('next-task-btn');
        const workArea = document.getElementById('work-area');
        const scoreDisplay = document.getElementById('score');

        startBtn.addEventListener('click', async () => {
            await unlockAudio();
            startGame();
        });
        startBtn.addEventListener('touchstart', unlockAudio, { passive: true });

        nextTaskBtn.addEventListener('click', hideExplanation);

        function startGame() {
            toggleMusic(true);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-play').classList.remove('hidden');
            gameActive = true;
            spawnQuestion();
            startTimer();
        }

        function startTimer() {
            const tb = document.getElementById('timer-bar');
            const itv = setInterval(() => {
                if (!gameActive) { clearInterval(itv); return; }
                if (!timerPaused) {
                    timeLeft -= 0.1;
                    tb.style.width = (timeLeft / 30 * 100) + '%';
                    if (timeLeft <= 0) endGame();
                }
            }, 100);
        }

        function spawnQuestion() {
            if (!gameActive || questionIndex >= questions.length) return;
            const data = questions[questionIndex];
            document.getElementById('left-label').innerText = data.left;
            document.getElementById('right-label').innerText = data.right;

            const pkg = document.createElement('div');
            pkg.className = 'package';
            pkg.innerHTML = `<div class="label-area"><div class="text-base font-black text-gray-800 leading-tight">${data.q}</div></div>`;
            workArea.appendChild(pkg);
            currentPackage = pkg;

            const handleStart = (x) => { unlockAudio(); startX = x; };
            const handleMove = (x) => {
                if (!currentPackage || timerPaused) return;
                const diff = x - startX;
                currentPackage.style.transform = `translateX(${diff}px) rotate(${diff/15}deg)`;
            };
            const handleEnd = (x) => {
                if (!currentPackage || timerPaused) return;
                const diff = x - startX;
                if (diff < -60) validate('left');
                else if (diff > 60) validate('right');
                else {
                    currentPackage.style.transition = '0.3s';
                    currentPackage.style.transform = 'translateX(0) rotate(0)';
                }
            };

            pkg.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientX), {passive: true});
            pkg.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive: false});
            pkg.addEventListener('touchend', (e) => handleEnd(e.changedTouches[0].clientX));
            pkg.addEventListener('mousedown', (e) => {
                handleStart(e.clientX);
                const onMM = (me) => handleMove(me.clientX);
                const onMU = (ue) => {
                    handleEnd(ue.clientX);
                    window.removeEventListener('mousemove', onMM);
                    window.removeEventListener('mouseup', onMU);
                };
                window.addEventListener('mousemove', onMM);
                window.addEventListener('mouseup', onMU);
            });
        }

        function validate(choice) {
            const data = questions[questionIndex];
            const isCorrect = choice === data.correct;
            timerPaused = true; 

            if (isCorrect) {
                score += 20;
                currentPackage.style.transition = '0.4s';
                currentPackage.style.transform = `translate(${choice === 'left' ? -200 : 200}px, 200px) scale(0)`;
                setTimeout(() => addBox(choice), 300);
            } else {
                score = Math.max(0, score - 10);
                currentPackage.style.transition = '0.5s';
                currentPackage.style.transform = `translateY(400px)`;
                document.body.classList.add('shake');
                setTimeout(() => document.body.classList.remove('shake'), 400);
            }
            scoreDisplay.innerText = score;
            showExp(isCorrect, data.desc);
        }

        function showExp(isCorrect, text) {
            const ind = document.getElementById('result-indicator');
            ind.innerText = isCorrect ? "æ­£ç¢ºï¼" : "éŒ¯èª¤...";
            ind.className = isCorrect ? "text-2xl font-black mb-2 text-green-600" : "text-2xl font-black mb-2 text-red-600";
            document.getElementById('explanation-text').innerText = text;
            setTimeout(() => document.getElementById('explanation-overlay').classList.remove('hidden'), 500);
        }

        function hideExplanation() {
            document.getElementById('explanation-overlay').classList.add('hidden');
            if (currentPackage) currentPackage.remove();
            questionIndex++;
            timerPaused = false;
            if (questionIndex >= questions.length) endGame();
            else spawnQuestion();
        }

        function addBox(side) {
            const b = document.createElement('div');
            b.className = 'stacked-box';
            b.innerText = `ğŸ“¦ OK`;
            (side === 'left' ? document.getElementById('left-pallet') : document.getElementById('right-pallet')).appendChild(b);
        }

        function endGame() {
            gameActive = false;
            isMusicPlaying = false; 
            document.getElementById('game-play').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            let rank = score >= 100 ? "ğŸ† è¶…ç´šæ‰“æ«ƒå¤§å¸«" : (score >= 60 ? "ğŸšš å°ˆæ¥­ç‰©æµäººå“¡" : "ğŸ“¦ å¯¦ç¿’ç†è²¨å“¡");
            document.getElementById('rank-text').innerText = rank;
        }
    </script>
</body>
</html>
